generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  name                  String?
  email                 String         @unique
  createdAt             DateTime       @default(now())
  lastLogin             DateTime?
  location              Location       @default(Tapion)
  role                  Role           @default(viewer)
  clerkId               String?        @unique
  id                    String         @unique @default(cuid())
  onboardedAt           DateTime?
  session               Sessions?
  stockLedger           StockLedger[]
  stockRequestsCreated  StockRequest[] @relation("StockRequestRequestedBy")
  stockRequestsReviewed StockRequest[] @relation("StockRequestReviewedBy")
}

model Sessions {
  id        String   @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String
  sessionId String?
  user      Users    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model Products {
  productId         String                @id @map("productId")
  name              String
  rating            Float?
  stockQuantity     Int
  category          String?
  minQuantity       Int?                  @default(0)
  reorderPoint      Int?
  supplier          String?
  unit              String?
  expiryDate        DateTime?
  createdAt         DateTime?             @default(now())
  sku               String?               @unique
  updatedAt         DateTime              @default(now()) @updatedAt
  imageUrl          String?
  Department        String?
  grnItems          GoodsReceiptItem[]
  inventory         Inventory[]
  poItems           PurchaseOrderItem[]
  Purchases         Purchases[]
  Sales             Sales[]
  stockMoves        StockLedger[]
  stockRequestLines StockRequestLine[]
  invoiceItems      SupplierInvoiceItem[]

  @@map("Products")
}

model Inventory {
  id            String   @id @default(cuid())
  productId     String
 
  lotNumber     String?  // temporary optional
  stockQuantity Int      @default(0)
  minQuantity   Int      @default(0)
  reorderPoint  Int      @default(0)
  lastCountedAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  product       Products @relation(fields: [productId], references: [productId])
  supplierId    String?
  supplier      Supplier? @relation(fields: [supplierId], references: [supplierId])

  @@unique([supplierId, productId, lotNumber])
  @@index([productId])
  @@index([supplierId])
  @@index([lotNumber])
}

model Sale {
  id              Int      @id @default(autoincrement())
  locationId      Int
  salesDate       DateTime
  hundredsCount   Int      @default(0)
  fiftiesCount    Int      @default(0)
  twentiesCount   Int      @default(0)
  tensCount       Int      @default(0)
  fivesCount      Int      @default(0)
  cashTotal       Decimal  @db.Decimal(10, 2)
  grandTotal      Decimal  @db.Decimal(10, 2)
  creditCardTotal Decimal  @default(0) @db.Decimal(10, 2)
  debitCardTotal  Decimal  @default(0) @db.Decimal(10, 2)
  chequeTotal     Decimal  @default(0) @db.Decimal(10, 2)
  notes           String?
  enteredBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([locationId, salesDate])
  @@index([salesDate])
  @@map("dailySales")
}

model SalesAuditLog {
  id         Int      @id @default(autoincrement())
  salesId    Int
  action     String   @db.VarChar(50)
  columnName String
  oldValue   String
  changedBy  String
  changedAt  DateTime @default(now())

  @@index([salesId])
  @@index([changedAt])
  @@map("sales_audit_log")
}

model Sales {
  productId   String
  timestamp   DateTime
  quantity    Int
  unitPrice   Float
  totalAmount Float
  saleId      String   @id
  product     Products @relation(fields: [productId], references: [productId])
}

model Purchases {
  purchaseId String   @id
  productId  String
  timestamp  DateTime
  quantity   Int
  unitCost   Float
  totalCost  Float
  product    Products @relation(fields: [productId], references: [productId])
}

model Expenses {
  expenseId   String   @id @default(uuid())
  category    String
  amount      Float
  description String?
  status      String   @default("pending")
  date        DateTime @default(now())
  group       String?
}

model SalesSummary {
  salesSummaryId   String   @id
  totalValue       Float
  changePercentage Float?
  date             DateTime
}

model PurchaseSummary {
  purchaseSummaryId String   @id
  totalPurchased    Float
  changePercentage  Float?
  date              DateTime
}

model ExpenseSummary {
  expenseSummaryId  String              @id
  totalExpenses     Float
  date              DateTime
  ExpenseByCategory ExpenseByCategory[]
}

model ExpenseByCategory {
  expenseByCategoryId String         @id
  expenseSummaryId    String
  category            String
  amount              BigInt
  date                DateTime
  expenseSummary      ExpenseSummary @relation(fields: [expenseSummaryId], references: [expenseSummaryId])
}

model Supplier {
  supplierId     String            @id @default(cuid())
  name           String
  email          String            @unique
  phone          String
  address        String
  purchaseOrders PurchaseOrder[]
  invoices       SupplierInvoice[]
  inventory     Inventory[]
}

model DraftProduct {
  id           String                @id @default(cuid())
  name         String                @unique
  unit         String                @default("")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  grnItems     GoodsReceiptItem[]
  poItems      PurchaseOrderItem[]
  invoiceItems SupplierInvoiceItem[]
}

model PurchaseOrder {
  id         String              @id @default(cuid())
  poNumber   String              @unique
  supplierId String
  status     POStatus            @default(DRAFT)
  orderDate  DateTime            @default(now())
  dueDate    DateTime?
  notes      String?
  subtotal   Decimal             @db.Decimal(14, 2)
  tax        Decimal             @db.Decimal(14, 2)
  total      Decimal             @db.Decimal(14, 2)
  grns       GoodsReceipt[]
  payments   InvoicePayment[]
  supplier   Supplier            @relation(fields: [supplierId], references: [supplierId])
  items      PurchaseOrderItem[]
  invoices   SupplierInvoice[]
  matches    ThreeWayMatch[]

  @@index([supplierId])
  @@index([poNumber])
}

model PurchaseOrderItem {
  id                String                @id @default(cuid())
  poId              String
  productId         String
  description       String?
  unit              String?
  quantity          Int
  unitPrice         Decimal               @db.Decimal(12, 2)
  lineTotal         Decimal               @db.Decimal(14, 2)
  promotedProductId String?
  grnLines          GoodsReceiptItem[]
  po                PurchaseOrder         @relation(fields: [poId], references: [id], onDelete: Cascade)
  product           DraftProduct          @relation(fields: [productId], references: [id])
  promotedProduct   Products?             @relation(fields: [promotedProductId], references: [productId])
  invoiceLines      SupplierInvoiceItem[]

  @@index([poId])
  @@index([productId])
  @@index([promotedProductId])
}

model SupplierInvoice {
  id               String                @id @default(cuid())
  invoiceNumber    String
  supplierId       String
  poId             String?
  status           InvoiceStatus         @default(PENDING)
  date             DateTime              @default(now())
  dueDate          DateTime?
  amount           Decimal               @db.Decimal(14, 2)
  balanceRemaining Decimal?              @db.Decimal(14, 2)
  goodsReceipt     GoodsReceipt?
  payments         InvoicePayment[]
  po               PurchaseOrder?        @relation(fields: [poId], references: [id])
  supplier         Supplier              @relation(fields: [supplierId], references: [supplierId])
  items            SupplierInvoiceItem[]
  matches          ThreeWayMatch?

  @@unique([invoiceNumber, supplierId])
  @@index([poId])
  @@index([supplierId])
}

model SupplierInvoiceItem {
  id             String             @id @default(cuid())
  invoiceId      String
  productId      String?
  description    String?
  uom            String?
  quantity       Int
  unitPrice      Decimal            @db.Decimal(12, 2)
  lineTotal      Decimal            @db.Decimal(14, 2)
  draftProductId String
  poItemId       String?
  grnLines       GoodsReceiptItem[]
  draftProduct   DraftProduct       @relation(fields: [draftProductId], references: [id])
  invoice        SupplierInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  poItem         PurchaseOrderItem? @relation(fields: [poItemId], references: [id])
  product        Products?          @relation(fields: [productId], references: [productId])

  @@index([invoiceId])
  @@index([poItemId])
  @@index([draftProductId])
  @@index([productId])
}

model GoodsReceipt {
  id        String             @id @default(cuid())
  grnNumber String             @unique
  poId      String?
  invoiceId String?            @unique
  date      DateTime           @default(now())
  status    GRNStatus          @default(DRAFT)
  invoice   SupplierInvoice?   @relation(fields: [invoiceId], references: [id])
  po        PurchaseOrder?     @relation(fields: [poId], references: [id])
  lines     GoodsReceiptItem[]
  matches   ThreeWayMatch?

  @@index([poId])
  @@index([invoiceId])
}

model GoodsReceiptItem {
  id              String               @id @default(cuid())
  grnId           String
  productId       String?
  unit            String?
  receivedQty     Int
  unitPrice       Decimal              @db.Decimal(12, 2)
  productDraftId  String
  poItemId        String?
  invoiceItemId   String?
  grn             GoodsReceipt         @relation(fields: [grnId], references: [id], onDelete: Cascade)
  invoiceItem     SupplierInvoiceItem? @relation(fields: [invoiceItemId], references: [id])
  poItem          PurchaseOrderItem?   @relation(fields: [poItemId], references: [id])
  product         DraftProduct         @relation(fields: [productDraftId], references: [id])
  promotedProduct Products?            @relation(fields: [productId], references: [productId])

  @@index([grnId])
  @@index([invoiceItemId])
  @@index([poItemId])
  @@index([productDraftId])
  @@index([productId])
}

model GrnCounter {
  dateKey   String   @id
  next      Int      @default(1)
  updatedAt DateTime @updatedAt
}

model StockLedger {
  id         String   @id @default(cuid())
  productId  String
  sourceType String
  SourceId   String
  qtyChange  Int
  memo       String?
  createdAt  DateTime @default(now())
  userId     String?
  product    Products @relation(fields: [productId], references: [productId])
  user       Users?   @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([SourceId, sourceType])
  @@index([userId])
}

model StockRequest {
  id                  String             @id @default(cuid())
  status              StockRequestStatus @default(SUBMITTED)
  requestedByName     String
  requestedByEmail    String
  requestedByLocation Location
  requestedByUserId   String?
  reviewedByUserId    String?
  expectedDeliveryAt  DateTime?
  messageToRequester  String?
  submittedAt         DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  requestedByUser     Users?             @relation("StockRequestRequestedBy", fields: [requestedByUserId], references: [id])
  reviewedByUser      Users?             @relation("StockRequestReviewedBy", fields: [reviewedByUserId], references: [id])
  lines               StockRequestLine[]

  @@index([status])
  @@index([requestedByLocation])
  @@index([requestedByUserId])
}

model StockRequestLine {
  id             String           @id @default(cuid())
  stockRequestId String
  productId      String
  requestedQty   Int
  grantedQty     Int?
  outcome        StockLineOutcome @default(PENDING)
  notes          String?
  createdAt      DateTime         @default(now())
  product        Products         @relation(fields: [productId], references: [productId])
  stockRequest   StockRequest     @relation(fields: [stockRequestId], references: [id], onDelete: Cascade)

  @@index([stockRequestId])
  @@index([productId])
}

model ThreeWayMatch {
  id           String          @id @default(cuid())
  poId         String
  invoiceId    String          @unique
  grnId        String          @unique
  status       MatchStatus     @default(DRAFT)
  payableTotal Decimal         @default(0)
  currency     String?         @default("EXD")
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  lines        MatchLine[]
  grn          GoodsReceipt    @relation(fields: [grnId], references: [id])
  invoice      SupplierInvoice @relation(fields: [invoiceId], references: [id])
  po           PurchaseOrder   @relation(fields: [poId], references: [id])

  @@unique([poId, invoiceId, grnId])
}

model MatchLine {
  id            String        @id @default(cuid())
  matchId       String
  poItemId      String?
  invoiceItemId String?
  grnLineId     String?
  name          String?
  unit          String?
  poQty         Int           @default(0)
  grnQty        Int           @default(0)
  invUnitPrice  Decimal?
  payableQty    Int           @default(0)
  payableAmount Decimal       @default(0)
  notes         String?
  createdAt     DateTime      @default(now())
  match         ThreeWayMatch @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
}

model InvoicePayment {
  id        String          @id @default(cuid())
  invoiceId String
  poId      String?
  amount    Decimal         @db.Decimal(14, 2)
  currency  String?         @default("XCD")
  paidAt    DateTime        @default(now())
  method    String?
  reference String?
  status    PaymentStatus   @default(POSTED)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  invoice   SupplierInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  po        PurchaseOrder?  @relation(fields: [poId], references: [id])

  @@index([poId])
  @@index([paidAt])
}

enum Role {
  admin
  inventoryClerk
  labStaff
  orderAgent
  viewer
}

enum Location {
  Tapion
  blueCoral
  manoelStreet
  sunnyAcres
  emCare
  RodneyBay
  memberCare
  vieuxFort
  soufriere
  other
}

enum Department {
  Administration
  SpecimenCollection
  heamatology
  Chemistry
  Offlines
  Cytology
  Bacteriology
  SpecialChemistry
}

enum POStatus {
  DRAFT
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
}

enum GRNStatus {
  DRAFT
  POSTED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  PARTIALLY_PAID
}

enum SourceType {
  GRN
  ADJUSTMENT
  STOCKTAKE
  CORRECTION
}

enum StockRequestStatus {
  SUBMITTED
  FULFILLED
  CANCELLED
  IN_REVIEW
}

enum StockLineOutcome {
  PENDING
  GRANTED
  ADJUSTED
  UNAVAILABLE
}

enum MatchStatus {
  DRAFT
  READY_TO_PAY
  PAID
  VOID
}

enum PaymentStatus {
  POSTED
  VOID
  PARTIALLY_PAID
}
